create table if not exists TIMESERIESDEF as from read_csv('./build/time_series_definitions.csv', AUTO_DETECT=true) ;
create table if not exists SITE_INSTRUMENTATION as from read_csv('./sample_data/src/SITE_INSTRUMENTATION.csv', AUTO_DETECT=true) ;
create table if not exists PARAMETERS_INSTRUMENTS as from read_csv('./sample_data/src/PARAMETERS_INSTRUMENTS.csv', AUTO_DETECT=true) ;
create table if not exists PARAMETERS as from read_csv('./sample_data/src/PARAMETERS.csv', AUTO_DETECT=true) ;

COPY(
SELECT SITE_INSTRUMENTATION.SITE_ID,PARAMETERS_INSTRUMENTS.PARAMETER_ID,TIMESERIESDEF.TIMESERIES_ID, TIMESERIESDEF.TIMESERIES_NAME, MIN(START_DATETIME) AS START_DATE,MAX(TIMESERIESDEF.PROCESSING_LEVEL) as PROCESSING_LEVEL,MAX(TIMESERIESDEF.DURATION) AS PERIOD
    FROM SITE_INSTRUMENTATION
    LEFT JOIN PARAMETERS_INSTRUMENTS ON SITE_INSTRUMENTATION.INSTRUMENT_ID == PARAMETERS_INSTRUMENTS.INSTRUMENT_ID
    LEFT JOIN PARAMETERS ON PARAMETERS_INSTRUMENTS.PARAMETER_ID=PARAMETERS.PARAMETER_ID
    LEFT JOIN TIMESERIESDEF ON TIMESERIESDEF.PARAMETER_ID=PARAMETERS_INSTRUMENTS.PARAMETER_ID
    WHERE TIMESERIES_ID IS NOT NULL
    GROUP BY SITE_INSTRUMENTATION.SITE_ID, PARAMETERS_INSTRUMENTS.PARAMETER_ID, TIMESERIESDEF.TIMESERIES_ID, TIMESERIESDEF.TIMESERIES_NAME
) TO './build/time_series_datasets.csv' (HEADER, DELIMITER ',');